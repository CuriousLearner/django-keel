"""Signal handlers for teams app."""
from django.db.models.signals import post_save
from django.dispatch import receiver

from apps.teams.models import Team, TeamMember


@receiver(post_save, sender=Team)
def create_owner_membership(sender, instance, created, **kwargs):
    """Automatically create owner membership when team is created."""
    if created:
        TeamMember.objects.get_or_create(
            team=instance,
            user=instance.owner,
            defaults={
                "role": "owner",
                "added_by": instance.owner,
            },
        )


{% if use_stripe and stripe_mode == 'advanced' -%}
@receiver(post_save, sender=TeamMember)
def update_stripe_subscription_quantity(sender, instance, created, **kwargs):
    """Update Stripe subscription quantity when members change."""
    if instance.team.stripe_subscription_id and instance.is_active:
        from apps.billing.utils import update_subscription_quantity

        active_members = instance.team.get_member_count()
        update_subscription_quantity(
            instance.team.stripe_subscription_id,
            active_members
        )
{% endif -%}
