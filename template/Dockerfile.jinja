# syntax=docker/dockerfile:1
{% if frontend == 'htmx-tailwind' and frontend_bundling == 'vite' -%}
# Build frontend assets
FROM node:25-slim AS frontend-builder

WORKDIR /app/frontend

# Copy frontend files
COPY frontend/package*.json ./

# Install dependencies
RUN npm ci

# Copy rest of frontend
COPY frontend/ ./

# Build assets (outputs to ../static/dist per vite.config.js)
RUN npm run build

{% endif -%}
FROM python:{{ python_version }}-slim as base

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Create app user
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq-dev \
    curl \
    gcc \
    python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Install just
RUN curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin

WORKDIR /app

{% if dependency_manager == 'uv' -%}
# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy dependency files and README (required by hatchling)
COPY pyproject.toml ./
COPY uv.lock* ./
COPY README.md ./

# Copy package directories needed for editable install
COPY apps/ ./apps/
COPY config/ ./config/

# Install dependencies
RUN uv sync --no-dev

# Copy rest of application
COPY . .

{% if frontend == 'htmx-tailwind' and frontend_bundling == 'vite' -%}
# Copy built frontend assets
COPY --from=frontend-builder /app/static/dist ./static/dist
{% endif -%}

{% else -%}
# Install poetry
RUN pip install poetry==1.7.0

# Copy dependency files and README (required by hatchling)
COPY pyproject.toml ./
COPY poetry.lock* ./
COPY README.md ./

# Copy package directories needed for editable install
COPY apps/ ./apps/
COPY config/ ./config/

# Install dependencies
RUN poetry config virtualenvs.create false \
    && poetry install --no-dev --no-interaction --no-ansi

# Copy rest of application
COPY . .

{% if frontend == 'htmx-tailwind' and frontend_bundling == 'vite' -%}
# Copy built frontend assets
COPY --from=frontend-builder /app/static/dist ./static/dist
{% endif -%}
{% endif -%}

# Change ownership
RUN chown -R appuser:appuser /app

USER appuser

# Expose port
EXPOSE 8000

# Run application
{% if use_channels -%}
{% if dependency_manager == 'uv' -%}
CMD ["uv", "run", "daphne", "-b", "0.0.0.0", "-p", "8000", "config.asgi:application"]
{% else -%}
CMD ["daphne", "-b", "0.0.0.0", "-p", "8000", "config.asgi:application"]
{% endif -%}
{% else -%}
{% if dependency_manager == 'uv' -%}
CMD ["uv", "run", "gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2"]
{% else -%}
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2"]
{% endif -%}
{% endif -%}
